---
sort: 18
title: 'Lesson 18: Setting up Sass'
---

Before we get into this one: it is a pretty _intense_ lesson, so if you felt like you need a break already, now is the time to have one!

For this project’s CSS, we’re going to be using Sass. If you’ve never heard of it, you’ll find a really good summary on the [Sass home page](https://sass-lang.com/):

> Sass is the most mature, stable, and powerful professional grade CSS extension language in the world.

This is exactly how we’ll be using Sass to write our CSS—as an extension of the native language. The main reason **why** is that it makes working with the CSS methodology we’ll be using—called [CUBE CSS](https://piccalil.li/cube-css/)—much easier.

> [!TIP]
> Before we dig deep into the front-end, I strongly recommend that you read [my article on CUBE CSS](https://piccalil.li/blog/cube-css/).
>
> We will of course cover it well in this course, but understanding why we’re using Sass will be a lot easier when you understand CUBE CSS.

In order to work with Sass, we’re going to add a custom template language for Sass through Eleventy to convert our `.scss` files into `.css` files that the browser can parse and understand. This is called [preprocessing](https://sass-lang.com/guide#topic-1).

## Adding Sass as custom template language

The first thing we need to do is add a custom template language for Sass to the configuration in your `eleventy.config.js` file:

```js
eleventyConfig.addExtension('scss', {
	outputFileExtension: 'css',
	useLayouts: false,
	compile: async function (inputContent, inputPath) {
		let parsed = path.parse(inputPath);
		// Don’t compile file names that start with an underscore
		if (parsed.name.startsWith('_')) {
			return;
		}

		let result = sass.compileString(inputContent, {
			loadPaths: [parsed.dir || '.', this.config.dir.includes],
		});

		// Map dependencies for incremental builds
		this.addDependencies(inputPath, result.loadedUrls);

		return async (data) => {
			return result.css;
		};
	},
});

eleventyConfig.addTemplateFormats('scss');
```

With `addExtension`, we register the `scss` file type and instruct Eleventy to use our `compile` function to process Sass files. In the `compile` function, we first ignore Sass [partials](https://sass-lang.com/guide/#partials) that begin with an `_` in the filename. Next, when we compile the result to a string, we make sure to load dependencies and partials in the same directory as the file being processed. We mark imported files as dependencies to Eleventy for incremental builds, and finally return a function that results in the compiled CSS.

This uses two new dependencies, `sass` and Node.js's `path` module, which need to be imported somewhere at the top of the file, above `export default function (eleventyConfig) {`:

```js
import path from 'node:path';
import sass from 'sass';
```

We have a new dependency here, so let’s install it. In your terminal, run the following:

```sh
npm install sass
```

## Letting Eleventy see our critical CSS

By default, Eleventy will ignore everything that we tell git to ignore with `.gitignore`. 99% of the time, we wouldn’t even need to worry about this, but because we’re ignoring `eleventy-from-scratch/src/_includes/css` in our `.gitignore` file, Eleventy won’t see it. This creates an issue because Eleventy won’t be able to directly include our critical CSS on the page, like this: `{% include "css/critical.css" %}`.

Luckily, there’s a simple workaround. Open up `eleventy-from-scratch/eleventy.config.js` and add the following just before the `return` block, around line 43:

```js
// Tell 11ty to use the .eleventyignore and ignore our .gitignore file
eleventyConfig.setUseGitIgnore(false);
```

As the code comment says, we’re telling Eleventy to use
`.eleventyignore`, so let’s configure that. Create a new file in your root
`eleventy-from-scratch` folder called `.eleventyignore` and add the following to it:

```
node_modules
```

What we’re saying to Eleventy here is: “You can access whatever you like: just ignore the node_modules folder”.

## Critical CSS

There’s one CSS file that appears on **every page** as **critical CSS**. Let’s create that.

We need to create a folder for our Sass, though, so inside `eleventy-from-scratch`, run the following command in your terminal:

```sh
mkdir src/scss
```

Now, in your new `scss` folder, create a file called `critical.scss` and add the following to it:

```scss
@import 'reset';
```

We need to create this file for `critical.scss` to import, so create a new file in the same folder called `_reset.scss` and add the following to it:

```scss
// A modified version of my "modern reset" https://github.com/hankchizljaw/modern-css-reset

/* Box sizing rules */
*,
*::before,
*::after {
	box-sizing: border-box;
}

/* Remove default padding */
ul[class],
ol[class] {
	padding: 0;
}

/* Remove default margin */
body,
h1,
h2,
h3,
h4,
p,
ul[class],
ol[class],
figure,
blockquote,
dl,
dd {
	margin: 0;
}

/* Set core root defaults */
html {
	scroll-behavior: smooth;
}

/* Set core body defaults */
body {
	min-height: 100vh;
	text-rendering: optimizeSpeed;
	line-height: 1.5;
}

/* Remove list styles on ul, ol elements with a class attribute */
ul[class],
ol[class] {
	list-style: none;
}

/* A elements that don’t have a class get default styles */
a:not([class]) {
	text-decoration-skip-ink: auto;
}

/* Make images easier to work with */
img {
	max-width: 100%;
	display: block;
}

/* Inherit fonts for inputs and buttons */
input,
button,
textarea,
select {
	font: inherit;
}

/* Remove all animations and transitions for people that prefer not to see them */
@media (prefers-reduced-motion: reduce) {
	* {
		animation-duration: 0.01s !important;
		animation-iteration-count: 1 !important;
		transition-duration: 0.01s !important;
		scroll-behavior: auto !important;
	}
}
```

This is a slightly modified version of this CSS reset that I created. You can read about it in my article, [A modern CSS reset](https://hankchizljaw.com/wrote/a-modern-css-reset/).

> [!TIP]
> You might have noticed that the file is called `_reset.scss`, rather than `reset.scss`. This is because Sass will ignore files with a `_` prefix unless they are imported with `@import`.

## Getting the CSS on the page

We’ve got our Gulp task set up and working well, but now we need to get some CSS on the page.

We’re going to add two snippets to the base layout: `base.html`. Open up `eleventy-from-scratch/src/_includes/layouts/base.html` and just before the closing `</head>`, at around **line 9**, add the following:

```njk
<style>{% include "css/critical.css" %}</style>

{# Add facility for pages to declare an array of critical styles #}
{% if pageCriticalStyles %}
	{% for item in pageCriticalStyles %}
		<style>{% include item %}</style>
	{% endfor %}
{% endif %}
```

The first thing we do here is include our base critical CSS, which we’ve already discussed. The interesting bit comes after this, though.

In our actual page layouts, like `work-item.html`, we can declare `pageCriticalStyles` as an array. Inside that array, we can set paths to other critical stylesheets. We’ll demonstrate this later in the course, but what it allows us to do is break up our critical styles into smaller, more succinct pieces, which is great for performance.

Straight after this, in `eleventy-from-scratch/src/_includes/layouts/base.html`: add the following:

```njk
<link rel="stylesheet" media="print" href="/fonts/fonts.css?{{ assetHash }}" onload="this.media='all'" />

{# Add facility for pages to declare an array of stylesheet paths #}
{% if pageStylesheets %}
	{% for item in pageStylesheets %}
		<link rel="stylesheet" media="print" href="{{ item }}?{{ assetHash }}" onload="this.media='all'" />
	{% endfor %}
{% endif %}
```

These are our **non-critical** styles. None of these CSS files exist yet, but we’ll make them soon. We have a similar setup where a page can declare `pageStylesheets` which, again, we’ll be using soon.

The important thing to make a note of here is a little performance trick of setting the `<link/>`’s `media` attribute to "print". This tells the browser to still download the file, but deprioritize it, which means more important content loads first without being blocked (known as render blocking).

When the file has finished downloading, we have a _tiny_ bit of JavaScript that converts the `media` attribute to `all`, which then allows the browser to parse it. If this JavaScript didn’t run, the loaded CSS would only be parsed if the browser **printed something**.

I urge you to read [this post about it on the Filament Group Blog](https://www.filamentgroup.com/lab/async-css.html). It’s super smart!

## Asset hashing

Ok, last bit of this _long_ lesson. When we add all of this CSS to the page, we’re referencing `{{ assetHash }}` a lot. We need to define that.

Open up `eleventy-from-scratch/src/_includes/layouts/base.html` and add the following **right at the top of the file**:

```njk
{% set assetHash = global.random() %}
```

Then, create a new file called `global.js` in your `_data` folder and add the following to it:

```js
export default {
	random() {
		const segment = () => {
			return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
		};
		return `${segment()}-${segment()}-${segment()}`;
	},
};
```

This does exactly what it says on the tin: it returns a random string. This helps to keep our asset cache fresh because every time Eleventy re-builds, it will be a unique value. This means that every time you deploy your site, you can guarantee that your users won’t have out of date CSS.

When you run `npm start` in your terminal now, you should see something that looks like this:

![The terminal saying that the site is ready to view at localhost 8080](/images/ss-gulp-sass.jpg)

## Wrapping up

Holy moly, this was a big one, right? The good news is that our Sass is set up, so writing CSS for this project will now be a _joy_.

Let’s move straight on to the next Gulp task.

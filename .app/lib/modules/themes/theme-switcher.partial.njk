{% set id = uniqueId() %}
{% set comma = joiner() %}
{% set themes = 
  [
    { key: 'light', label: 'theme_switcher.options.light', icon: 'sun'  },
    { key: 'dark', label: 'theme_switcher.options.dark', icon: 'moon'  },
    { key: 'system', label: 'theme_switcher.options.system', icon: 'monitor' }
  ]
%}

<div 
  class="theme-switcher" 
  x-data="themeSwitcher"
  x-init="themes = [{% for theme in themes %}{{ comma() }}'{{ theme.key }}'{% endfor %}]"
  x-cloak 
  lang="{% uiLang %}" 
>
  <button
    type="button"
    class="icon-btn"
    aria-label="{{ 'theme_switcher.label' | t }}"
    aria-haspopup="menu"
    aria-controls="{{ id('menu') }}"
    :aria-expanded="open"
    x-ref="trigger"
    @click="openMenu()"
  >
  {{ 'sun-moon' | icon | safe }}
  </button>

  <div class="theme-switcher__backdrop" x-show="open"></div>
  <div
    id="{{ id('menu') }}"
    role="menu"
    aria-label="{{ 'theme_switcher.label' | t }}"
    x-ref="menu"
    x-show="open"
    x-transition.origin.top.right
    class="theme-switcher__menu"
    @mousedown.prevent.self
    @keydown.prevent.escape="closeMenu()"
    @focusout="onFocusOut($event)"
  >
    {% for theme in themes %}
    <div
      role="menuitemradio"
      class="theme-switcher__menu-item"
      :aria-checked="$store.appearance.theme === '{{ theme.key }}'"
      :tabindex="focusedIdx === {{ loop.index0 }} ? 0 : -1"
      :data-focused="focusedIdx === {{ loop.index0 }}"
      @click="selectTheme('{{ theme.key }}')"
      @mousemove="focusOnNextTick({{ loop.index0 }})"
      @keydown.enter.prevent="selectTheme('{{ theme.key }}')"
      @keydown.space.prevent="selectTheme('{{ theme.key }}', { keepOpen: true })" 
      @keydown.arrow-down.prevent="focusNext()"
      @keydown.arrow-up.prevent="focusPrevious()"
    >
      {{ theme.icon | icon | safe }}
      <span class="theme-switcher__menu-item-label">{{ theme.label | t }}</span>
      <span x-show="$store.appearance.theme === '{{ theme.key }}'">
        {{ 'check' | icon({ width: "1em", height: "1em" }) | safe }}
      </span>
    </div>
    {% endfor %}
  </div>
</div>
